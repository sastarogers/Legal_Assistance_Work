<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- *** CHANGE TITLE *** -->
    <title>Find Legal Assistance - Legal Assist Bot</title>

    <!-- CSS Links (Keep As Is) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles (Keep As Is) -->
    <style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --card-bg: var(--secondary-bg);
            --accent: #7E57C2;
            --accent-hover: #673AB7;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --border-light: rgba(255, 255, 255, 0.1);
            --bs-border-radius-lg: 1rem;
            --user-message-bg: var(--accent);
            --bot-message-bg: #2a2a2a;
            --option-button-bg: #3f3f3f; /* Background for option buttons */
            --option-button-hover-bg: #505050;
            --option-button-text: var(--text-primary);
        }
        /* ... (Keep all existing CSS styles) ... */
        .system-info { /* Style for info/error messages */
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            text-align: center;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-style: italic;
        }
        .system-info.error { color: #cf6679; }
        .system-info.success { color: #4caf50; }

    </style>
</head>
<body>
    <!-- Header (Keep As Is, maybe update link/text) -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand logo" href="home.html"> <!-- Link back to client home/dashboard -->
                <i class="fas fa-balance-scale logo-icon"></i>
                Legal Assist Bot
            </a>
             <button class="btn btn-sm btn-outline-light" id="logout-button">
                 <i class="fas fa-sign-out-alt me-1"></i>
                 Sign Out
             </button>
        </div>
    </nav>

    <!-- Main Chat Area (Keep As Is) -->
    <main class="chat-container container">
        <div class="chat-window" id="chat-window">
            <div class="message-list" id="message-list">
                <!-- Messages will be added here dynamically by JS -->
                 <!-- ** Added system message area ** -->
                 <div id="system-message-area" class="system-info">Initializing...</div>
            </div>
        </div>
        <div class="chat-input-area">
            <textarea class="form-control chat-input" id="chat-input" placeholder="Type your response..." rows="1" disabled></textarea>
            <button class="btn chat-send-btn" id="send-button" aria-label="Send message" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </main>

    <!-- Footer (Keep As Is) -->
    <footer>
        <div class="container text-center">
            <p class="footer-text mb-0">Â© 2025 Legal Assist. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- *** ADD FIREBASE SDKs *** -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <!-- Firestore might be needed if fetching client name, etc. Optional for basic flow. -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script> -->

    <script>
        // === CHAT LOGIC START ===
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const messageList = document.getElementById('message-list');
            const chatWindow = document.getElementById('chat-window');
            const logoutButton = document.getElementById('logout-button');
            const systemMessageArea = document.getElementById('system-message-area'); // Get system message div

            // --- Firebase Config (Same as lawyer_info.html) ---
             const firebaseConfig = {
                 apiKey: "YOUR_API_KEY", // Replace
                 authDomain: "YOUR_AUTH_DOMAIN", // Replace
                 projectId: "YOUR_PROJECT_ID",                // Replace
                 storageBucket: "YOUR_STORAGE_BUCKET", // Replace
                 messagingSenderId: "YOUR_MESSAGING_SENDER_ID",              // Replace
                 appId: "YOUR_APP_ID", // Replace
                 measurementId: "YOUR_MEASUREMENT_ID" // Optional
             };

             // --- Initialize Firebase ---
             let app, auth, db;
             let currentUser = null; // Store logged-in user info
             try {
                 if (!firebase.apps.length) {
                     app = firebase.initializeApp(firebaseConfig);
                 } else {
                     app = firebase.app();
                 }
                 auth = firebase.auth();
                 // db = firebase.firestore(); // Uncomment if needed
                 console.log("Firebase Initialized on chat.html");
             } catch (e) {
                 console.error("Firebase initialization error:", e);
                 showSystemMessage("Error initializing application. Cannot proceed.", "error");
                 toggleInputArea(false); // Keep input disabled
                 // Potentially redirect or disable everything
             }

            // --- Authentication Check ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    console.log("Client logged in:", currentUser.uid);
                     showSystemMessage(`Welcome! Starting chat session...`, "success");
                     // Start the chat flow *only after* confirming login
                     askToStart();
                } else {
                    currentUser = null;
                    console.log("Client not logged in. Redirecting...");
                    showSystemMessage("You must be logged in to use the chat. Redirecting...", "error");
                    toggleInputArea(false);
                    setTimeout(() => {
                        window.location.href = 'client_login.html'; // Or your main client login page
                    }, 2500);
                }
            });


            // --- State Management & Helper Functions (Keep As Is) ---
            let currentChatState = 'AWAITING_START';
            const userData = { /* ... */ };
            const caseTypeOptions = ["Divorce", "Criminal", "Property", "Labor", "Other"];

            function scrollToBottom() { /* ... keep as is ... */ }

            function toggleInputArea(enabled, placeholder = "Type your response...") {
                // Only enable if user is logged in
                const shouldEnable = enabled && !!currentUser;
                chatInput.disabled = !shouldEnable;
                sendButton.disabled = !shouldEnable;
                chatInput.placeholder = shouldEnable ? placeholder : (currentUser ? "Please select an option above..." : "Please log in...");
                if (!shouldEnable) {
                    chatInput.value = '';
                    chatInput.style.height = 'auto';
                }
             }

             // *** IMPORTANT: Update addMessage to handle the lawyer selection handler ***
            function addMessage(text, type, options = []) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', type === 'user' ? 'user-message' : 'bot-message');

                const messageP = document.createElement('p');
                messageP.innerHTML = text.replace(/\n/g, '<br>');
                messageDiv.appendChild(messageP);

                if (options.length > 0 && type === 'bot') {
                    const optionsDiv = document.createElement('div');
                    optionsDiv.classList.add('message-options');

                    options.forEach(option => {
                        const button = document.createElement('button');
                        button.classList.add('option-button');

                        if (typeof option === 'string') {
                            // Simple Text Button (e.g., case types)
                            button.textContent = option;
                            button.addEventListener('click', () => {
                                // No need to add "Selected: ..." message for simple choices, looks cleaner
                                // addMessage(`Selected: ${option}`, 'user');
                                optionsDiv.querySelectorAll('.option-button').forEach(btn => btn.disabled = true);
                                handleUserInput(option); // Pass the selected text value
                            });
                        } else if (typeof option === 'object' && option.text && option.dataAttributes && option.handler) {
                            // ** This case is for LAWYER buttons **
                            button.textContent = option.text;
                            // Attach data attributes (like lawyerId)
                            for (const key in option.dataAttributes) {
                                button.dataset[key] = option.dataAttributes[key];
                            }
                            // Attach the specific handler (handleLawyerSelection)
                            button.addEventListener('click', option.handler);
                        }
                        optionsDiv.appendChild(button);
                    });
                    messageDiv.appendChild(optionsDiv);
                }

                messageList.appendChild(messageDiv);
                scrollToBottom();
            }

            // --- Conversation Flow Functions (Keep askToStart, askCaseType, etc. as is) ---
            function askToStart() { /* ... keep as is ... */ }
            function askCaseType() { /* ... keep as is ... */ }
            function askLocation() { /* ... keep as is ... */ }
            function askBudget() { /* ... keep as is ... */ }
            function askDetails() { /* ... keep as is ... */ }

            // --- Update showLawyers ---
            function showLawyers() {
                 chatInput.rows = 1;
                 addMessage("Thank you for the details. Searching for lawyers based on:\n"+
                            `- Case Type: ${userData.caseType || 'N/A'}\n`+ // Handle potentially null values
                            `- Location: ${userData.location || 'N/A'}\n`+
                            `- Budget: ${userData.budget || 'N/A'}\n`+
                            `- Details: (Provided)`
                 , 'bot');
                 toggleInputArea(false, "Searching for lawyers...");
                 currentChatState = 'SHOWING_LAWYERS';

                 // --- !!! Placeholder: Backend Integration Needed !!! ---
                 addMessage("<i>Finding suitable lawyers... Please wait.</i>", 'bot');

                 // ** Replace this setTimeout with a fetch() call to your backend API **
                 // Example fetch:
                 // const backendUrl = 'https://your-main-website.com/api/find-lawyers'; // Your actual backend endpoint
                 // fetch(backendUrl, {
                 //     method: 'POST',
                 //     headers: { 'Content-Type': 'application/json', /* Add Auth header if needed */ },
                 //     body: JSON.stringify(userData)
                 // })
                 // .then(response => {
                 //     if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                 //     return response.json();
                 // })
                 // .then(data => {
                 //      removeLoadingMessage();
                 //      displayLawyerResults(data.lawyers); // Assuming backend returns { lawyers: [...] }
                 // })
                 // .catch(error => {
                 //     console.error("Error fetching lawyers:", error);
                 //     removeLoadingMessage();
                 //     addMessage("Sorry, there was an error finding lawyers. Please try again later or contact support.", 'bot');
                 //     // Optionally allow user to restart?
                 // });

                  // Simulate backend call & response (KEEP FOR TESTING UNTIL BACKEND IS READY)
                 setTimeout(() => {
                     removeLoadingMessage();
                     const mockLawyers = [
                         { id: 'lawyer123', name: `Adv. ${userData.caseType} Specialist`, location: userData.location || 'Nearby', rating: 4.8 },
                         { id: 'lawyer456', name: `Adv. ${userData.caseType} Expert`, location: userData.location || 'Nearby', rating: 4.5 },
                         { id: 'lawyer789', name: `Law Firm ${userData.caseType} Group`, location: userData.location || 'Nearby', rating: 4.2 }
                     ];
                     displayLawyerResults(mockLawyers);
                 }, 2500);
            }

            // --- Update displayLawyerResults ---
            function displayLawyerResults(lawyers) {
                 if (lawyers && lawyers.length > 0) {
                     let lawyerIntroText = "Based on your information, here are a few suggested lawyers. Click on a name to request a chat:\n";
                     addMessage(lawyerIntroText, 'bot');

                     const lawyerButtons = lawyers.map((lawyer) => {
                         return {
                             text: `${lawyer.name} (${lawyer.location}, Rating: ${lawyer.rating || 'N/A'})`,
                             dataAttributes: { // Data to attach to the button element
                                 lawyerId: lawyer.id,
                                 lawyerName: lawyer.name
                             },
                             // *** CRITICAL: Use the NEW handler ***
                             handler: handleLawyerSelectionRequest
                         };
                     });

                     addMessage("--- Suggestions ---", 'bot', lawyerButtons);
                     addMessage("<i>You will be notified on your dashboard when the lawyer accepts your chat request.</i>", 'bot'); // Inform user

                 } else {
                     addMessage("I couldn't find specific lawyer suggestions based on the information provided. You may want to try broadening your criteria or searching manually.", 'bot');
                     currentChatState = 'ENDED';
                     toggleInputArea(false, "Chat ended.");
                 }
                 toggleInputArea(false, "Please select a lawyer above."); // Keep text input disabled
            }

             // --- NEW Handler for Lawyer Button Clicks - Initiates Chat Request ---
             async function handleLawyerSelectionRequest(event) {
                 const button = event.currentTarget;
                 const lawyerId = button.dataset.lawyerId;
                 const lawyerName = button.dataset.lawyerName;

                 if (!lawyerId) {
                     console.error("Lawyer ID not found on the button.");
                     addMessage("Sorry, there was an error selecting that lawyer.", 'bot');
                     return;
                 }
                 if (!currentUser) {
                     addMessage("Error: You seem to be logged out. Please log in again.", 'bot');
                     // Optionally redirect to login
                     return;
                 }

                 // Disable all buttons in the group immediately
                 const optionsDiv = button.closest('.message-options');
                 if (optionsDiv) {
                     optionsDiv.querySelectorAll('.option-button').forEach(btn => btn.disabled = true);
                 }

                 addMessage(`Requesting chat with ${lawyerName}...`, 'user'); // Show user action
                 toggleInputArea(false, "Sending chat request..."); // Disable further input

                 // --- !!! Backend Integration: Call /api/chat/request !!! ---
                 const chatRequestUrl = 'https://your-main-website.com/api/chat/request'; // ** MUST BE YOUR ACTUAL BACKEND URL **

                 try {
                     const response = await fetch(chatRequestUrl, {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json',
                             // 'Authorization': `Bearer ${await currentUser.getIdToken()}` // Add Firebase Auth token if backend requires it
                         },
                         body: JSON.stringify({
                             lawyerId: lawyerId,
                             clientId: currentUser.uid // Send the logged-in client's UID
                         })
                     });

                     if (!response.ok) {
                         // Try to get error message from backend response body
                         let errorMsg = `HTTP error ${response.status}`;
                         try {
                             const errorData = await response.json();
                             errorMsg = errorData.message || errorMsg;
                         } catch (parseError) { /* Ignore if body isn't JSON */ }
                         throw new Error(errorMsg);
                     }

                     // Optional: Backend might return the chatSessionId if needed immediately, but likely not required for this flow
                     // const responseData = await response.json();
                     // console.log("Chat request successful:", responseData);

                     addMessage(`Chat request sent to ${lawyerName}. Please check your main dashboard for notifications when they accept. This bot session will now end.`, 'bot');
                     currentChatState = 'ENDED'; // End the bot flow here

                 } catch (error) {
                     console.error("Error sending chat request:", error);
                     addMessage(`Sorry, there was an error sending the chat request to ${lawyerName}. Error: ${error.message}. Please try again later or contact support.`, 'bot');
                     // Re-enable buttons on error? Or leave disabled? Depends on desired UX.
                      if (optionsDiv) {
                          optionsDiv.querySelectorAll('.option-button').forEach(btn => btn.disabled = false); // Example: Re-enable
                      }
                     toggleInputArea(false, "Error sending request. Please try again."); // Keep input disabled or guide user
                 }
             }


            // --- Main Input Handler (Keep As Is) ---
            function handleUserInput(input = null) {
                 /* ... keep existing state machine logic ... */
                const text = input !== null ? input : chatInput.value.trim();

                if (!text && input === null) return;

                 // Add user message only if it came from the text input
                  if (input === null) {
                      addMessage(text, 'user');
                      chatInput.value = '';
                      chatInput.style.height = 'auto';
                  }

                // State Machine Logic (no changes needed inside the switch for this integration)
                switch (currentChatState) {
                    case 'AWAITING_START':
                         if (text.toLowerCase() === 'hi' || text.toLowerCase() === 'start') askCaseType();
                         else addMessage("Please type 'Hi' or 'Start' to begin.", 'bot');
                         break;
                    case 'AWAITING_CASE_TYPE':
                         if (caseTypeOptions.includes(text)) { userData.caseType = text; askLocation(); }
                         break;
                    case 'AWAITING_LOCATION':
                         if (text) { userData.location = text; askBudget(); }
                         else { addMessage("Please enter your City and State.", 'bot'); toggleInputArea(true, "Enter City, State..."); }
                         break;
                    case 'AWAITING_BUDGET':
                         if (text) { userData.budget = text; askDetails(); }
                         else { addMessage("Please provide an approximate budget.", 'bot'); toggleInputArea(true, "Enter approximate budget..."); }
                         break;
                     case 'AWAITING_DETAILS':
                          if (text) { userData.details = text; showLawyers(); }
                          else { addMessage("Please describe your case briefly.", 'bot'); toggleInputArea(true, "Describe your case briefly..."); }
                          break;
                     case 'SHOWING_LAWYERS':
                          addMessage("Please click on one of the lawyer options above to request a chat.", 'bot');
                          break;
                    case 'ENDED':
                         addMessage("This chat has concluded. Please refresh the page or return to your dashboard.", 'bot');
                         toggleInputArea(false, "Chat ended.");
                         break;
                     default:
                         console.warn("Reached default state handler for state:", currentChatState);
                         addMessage("Sorry, I seem to have lost my place. Let's start over.", 'bot');
                         askToStart();
                 }

             }


            // --- Event Listeners (Keep As Is) ---
            if (sendButton && chatInput) { /* ... keep existing listeners ... */ }
            if(logoutButton){
                 logoutButton.addEventListener('click', () => {
                    console.log('Logout initiated...');
                     auth.signOut().then(() => {
                         // Sign-out successful. Auth state change listener will handle redirect.
                         console.log('User signed out.');
                     }).catch((error) => {
                         console.error('Sign out error', error);
                         showSystemMessage(`Error signing out: ${error.message}`, "error");
                     });
                });
            }

             // --- System Message Helper ---
             function showSystemMessage(message, type = "info") {
                 if (systemMessageArea) {
                     systemMessageArea.textContent = message;
                     systemMessageArea.className = `system-info ${type}`; // Set class based on type
                     systemMessageArea.style.display = 'block';
                 } else {
                     // Fallback if the dedicated area isn't found (add as a bot message)
                     addMessage(`<i>System: ${message}</i>`, 'bot');
                 }
             }


            // --- Initialise Chat ---
            // ** Don't call askToStart() here. It's called inside the onAuthStateChanged listener **
             showSystemMessage("Checking login status...", "info");
             toggleInputArea(false); // Start disabled

        });
        // === CHAT LOGIC END ===
    </script>

</body>
</html>
